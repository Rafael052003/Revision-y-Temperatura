<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chitré Selecto</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --primary-color: #111827; --secondary-color: #374151; --bg-light: #f4f5f7; --accent-green: #0A7456; --accent-red: #E34F4F; --highlight-yellow: #fff2b0; --highlight-green: #d4edda; --highlight-red: #f8d7da; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-light); color: var(--primary-color); padding: 0; }
        .main-content { padding: 20px; }
        .container { max-width: 960px; margin: 0 auto; }
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-color); color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; }
        #splash img { width: 120px; margin-bottom: 20px; }
        #splash h2 { font-weight: bold; font-size: 24px; margin-bottom: 10px; }
        #splash p { margin-top: 5px; font-size: 14px; opacity: 0.9; }
        header { text-align: center; margin-bottom: 24px; display: flex; align-items: center; position: relative; padding-left: 60px; padding-right: 20px; }
        .title-group { flex-grow: 1; display: flex; flex-direction: column; align-items: center; }
        .title-group h1 { font-size: 24px; font-weight: 700; margin: 2px 0; color: var(--primary-color); text-transform: uppercase; }
        @media (max-width: 600px) { .title-group h1 { font-size: 18px; } }
        .header-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .header-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-row label {
            font-weight: 600;
            white-space: nowrap;
        }
        .header-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .controls-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px; }
        .action-btn { background: var(--primary-color); color: white; border: 0; padding: 12px 24px; border-radius: 999px; cursor: pointer; font-weight: 600; transition: all 0.2s ease-in-out; display: flex; align-items: center; gap: 8px; }
        .action-btn:hover { background: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .action-btn.danger { background: var(--accent-red); }
        .action-btn.danger:hover { background: #dc2626; }
        .action-btn.green { background: var(--accent-green); }
        .action-btn.green:hover { background: #08664b; }
        .action-btn.blue { background: #3b82f6; }
        .action-btn.blue:hover { background: #2563eb; }
        #installButton { display: none; }
        .chips { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .chip { padding: 8px 16px; border-radius: 999px; cursor: pointer; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s ease-in-out; font-size: 14px; }
        .chip.active { background: var(--primary-color); color: white; }
        .table-container { overflow-x: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 8px; }
        .main-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; background: white; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: center; }
        th { background: #f3f4f6; font-weight: 600; white-space: nowrap; }
        td.left { text-align: left; }
        th.product-sensitive { white-space: normal; line-height: 1.2; }
        input[type="number"], input[type="text"], input[type="tel"] { width: 100%; border: 0; text-align: center; background: transparent; font-size: 14px; padding: 2px; outline: none; transition: background-color 0.3s; }
        td[contenteditable="true"] { background: #fefce8; }
        .selected-row { background-color: #e0f7fa !important; }
        .initial-highlight { background-color: var(--highlight-yellow) !important; }
        .increased { background-color: var(--highlight-green) !important; }
        .decreased { background-color: var(--highlight-red) !important; }
        .toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column-reverse; gap: 10px; z-index: 1000; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); animation: slideIn 0.5s forwards; }
        .toast.success { background-color: var(--accent-green); }
        .toast.warning { background-color: #ff9800; }
        .toast.error { background-color: var(--accent-red); }
        @keyframes slideIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
        /* Estilos del nuevo submenú */
        .side-menu { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: var(--primary-color); color: white; padding: 20px; z-index: 1001; box-shadow: 2px 0 5px rgba(0,0,0,0.5); transition: left 0.3s ease-in-out; display: flex; flex-direction: column; gap: 10px; }
        .side-menu.open { left: 0; }
        .side-menu .action-btn { width: 100%; justify-content: flex-start; margin: 0; }
        .hamburger-btn { font-size: 24px; cursor: pointer; color: var(--primary-color); padding: 10px; position: absolute; left: 0; top: 50%; transform: translateY(-50%); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
        .overlay.active { display: block; }
        /* Estilos del Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fff; margin: 15% auto; padding: 20px 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.4s ease-out; }
        .modal-content h2 { color: var(--primary-color); font-size: 24px; margin-bottom: 10px; }
        .modal-content p { color: var(--secondary-color); font-size: 14px; margin-bottom: 20px; }
        .modal-icon { font-size: 48px; color: var(--accent-red); margin-bottom: 20px; }
        .modal-actions { display: flex; justify-content: space-around; gap: 15px; }
        .modal-actions button { flex: 1; }
        .close-btn { color: var(--secondary-color); position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover, .close-btn:focus { color: var(--primary-color); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Estilos para el PDF/Impresión */
        @media print {
            @page { margin: 10mm; }
            body { padding: 0; font-family: 'Poppins', sans-serif; font-size: 12pt; }
            .container, header, .controls-container, .chips, .actions, .hamburger-btn, .side-menu, .overlay, .toast-container, .modal, .modal-content, .print-btn { display: none; }
            .printable-content { display: block !important; padding: 0; }
            .page-break { page-break-before: always; }
            .pdf-header { text-align: center; margin-bottom: 20px; }
            .pdf-header h1 { font-size: 20pt; margin: 2px 0; font-weight: 700; text-transform: uppercase; }
            .pdf-header p { font-size: 16pt; font-weight: bold; margin-top: 5px; text-align: center; }
            .pdf-header-details {
                display: flex;
                justify-content: space-between;
                width: 90%;
                margin: 0 auto 20px auto;
                font-size: 12pt;
                font-weight: bold;
            }
            .pdf-section-title { text-align: center; font-size: 16pt; font-weight: 700; margin-top: 20px; text-transform: uppercase;}
            .main-table { border-collapse: collapse; margin: 10px auto; font-size: 12pt; table-layout: fixed; width: 90%; }
            th, td { border: 1px solid #333; padding: 8px; text-align: center; }
            th { background: #f0f0f0; font-weight: bold; }
            .increased { background-color: #d4edda !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .decreased { background-color: #f8d7da !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .pdf-footer { position: fixed; bottom: 20px; width: 100%; text-align: center; font-size: 16pt; font-weight: bold; color: #666; }
            /* Anchos de columna específicos para cada tabla en PDF */
            #temperaturas-tabla th:nth-child(1), #temperaturas-tabla td:nth-child(1) { width: 10%; }
            #temperaturas-tabla th:nth-child(2), #temperaturas-tabla td:nth-child(2) { width: 40%; text-align: left; }
            #temperaturas-tabla th:nth-child(3), #temperaturas-tabla td:nth-child(3) { width: 12.5%; }
            #temperaturas-tabla th:nth-child(4), #temperaturas-tabla td:nth-child(4) { width: 12.5%; }
            #temperaturas-tabla th:nth-child(5), #temperaturas-tabla td:nth-child(5) { width: 12.5%; }
            #temperaturas-tabla th:nth-child(6), #temperaturas-tabla td:nth-child(6) { width: 12.5%; }
            #revisiones-tabla th:nth-child(1), #revisiones-tabla td:nth-child(1) { width: 25%; text-align: left; }
            #revisiones-tabla th:nth-child(2), #revisiones-tabla td:nth-child(2) { width: 15%; }
            #revisiones-tabla th:nth-child(3), #revisiones-tabla td:nth-child(3) { width: 20%; }
            #revisiones-tabla th:nth-child(4), #revisiones-tabla td:nth-child(4) { width: 15%; }
            #revisiones-tabla th:nth-child(5), #revisiones-tabla td:nth-child(5) { width: 20%; }
            #revisiones-tabla th:nth-child(6), #revisiones-tabla td:nth-child(6) { width: 15%; }
        }
    </style>
</head>
<body>
    <div id="splash">
        <img src="icon-192.png" alt="Logo">
        <h2>REVISIÓN Y TEMPERATURA</h2>
        <p>Powered by Rafael Ramos</p>
        <p>Versión 2.2</p>
    </div>

    <div id="sideMenu" class="side-menu">
        <button id="btnExportJson_menu" class="action-btn blue"><i class="fas fa-file-export"></i> Exportar Datos</button>
        <input type="file" id="fileInput" style="display: none;" accept=".json">
        <button id="btnImportJson_menu" class="action-btn blue"><i class="fas fa-file-import"></i> Importar Datos</button>
        <button id="installButton" class="action-btn blue"><i class="fas fa-download"></i> Instalar App</button>
    </div>
    <div id="overlay" class="overlay"></div>

    <div class="main-content container">
        <header>
            <div id="hamburgerBtn" class="hamburger-btn">☰</div>
            <div class="title-group">
                <h1>GRUPO RIBA SMITH</h1>
                <h1>R/S CHITRÉ SELECTO</h1>
                <h1 id="main-title">REVISIÓN DE INSTALACIONES</h1>
            </div>
        </header>

        <div class="header-info">
            <div class="header-row">
                <label for="review-date">Fecha de Revisión:</label>
                <input type="date" id="review-date">
            </div>
            <div class="header-row">
                <label for="vespertino-nombre">Revisión Vespertina:</label>
                <input type="text" id="vespertino-nombre" placeholder="Nombre (turno vespertino)">
            </div>
            <div class="header-row">
                <label for="nocturno-nombre">Revisión Nocturna:</label>
                <input type="text" id="nocturno-nombre" placeholder="Nombre (turno nocturno)">
            </div>
        </div>

        <div class="controls-container">
            <div class="chips" id="chips"></div>
        </div>
        
        <div class="actions">
            <button id="btnAdd" class="action-btn"><i class="fas fa-plus"></i> Agregar Fila</button>
            <button id="btnExport" class="action-btn green"><i class="fas fa-file-pdf"></i> Generar PDF</button>
            <button id="btnClear" class="action-btn danger"><i class="fas fa-eraser"></i> Borrar Horarios</button>
            <button id="btnDeleteRow" class="action-btn danger"><i class="fas fa-trash-alt"></i> Eliminar Fila</button>
        </div>

        <div class="table-container" id="temperaturas-table-container">
            <table id="temperaturas-tabla" class="main-table">
                <thead>
                    <tr>
                        <th>TEMP</th>
                        <th class="left product-sensitive">NEVERAS</th>
                        <th>22:00</th>
                        <th>00:00</th>
                        <th>02:00</th>
                        <th>04:00</th>
                    </tr>
                </thead>
                <tbody id="temperaturas-tbody"></tbody>
            </table>
        </div>

        <div class="table-container" id="revisiones-table-container" style="display: none;">
            <table id="revisiones-tabla" class="main-table">
                <thead>
                    <tr>
                        <th>PUERTAS Y/O ÁREAS</th>
                        <th>REVISIÓN Nº1</th>
                        <th>OBSERVACIÓN</th>
                        <th>REVISIÓN Nº2</th>
                        <th>OBSERVACIÓN</th>
                        <th>REVISIÓN Nº3</th>
                        <th>OBSERVACIÓN</th>
                    </tr>
                </thead>
                <tbody id="revisiones-tbody"></tbody>
            </table>
        </div>

        <div id="toast" class="toast-container"></div>
    </div>
    
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <i class="fas fa-trash-alt modal-icon"></i>
            <h2>¿Eliminar Fila?</h2>
            <p>Esta acción no se puede deshacer.</p>
            <div class="modal-actions">
                <button id="modalConfirmBtn" class="action-btn danger">Confirmar</button>
                <button id="modalCancelBtn" class="action-btn blue">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="clearModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <i class="fas fa-eraser modal-icon"></i>
            <h2>¿Borrar Horarios?</h2>
            <p>Esta acción eliminará todos los datos de la sección activa.</p>
            <div class="modal-actions">
                <button id="clearModalConfirmBtn" class="action-btn danger">Confirmar</button>
                <button id="clearModalCancelBtn" class="action-btn blue">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Fallo en el registro de Service Worker:', error);
                    });
            });
        }
        
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'flex';
        });
        installButton.addEventListener('click', () => {
            installButton.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('El usuario aceptó instalar la PWA');
                } else {
                    console.log('El usuario rechazó instalar la PWA');
                }
                deferredPrompt = null;
            });
        });

        (function () {
            const DEFAULT_SECCIONES = ['TEMPERATURAS', 'REVISIONES'];
            const STORAGE_KEY_TEMPERATURAS = 'data_temperaturas';
            const STORAGE_KEY_REVISIONES = 'data_revisiones';
            let dataTemperaturas = JSON.parse(localStorage.getItem(STORAGE_KEY_TEMPERATURAS));
            let dataRevisiones = JSON.parse(localStorage.getItem(STORAGE_KEY_REVISIONES));

            const initialTemperaturesData = [
                { temp: '-20°', nevera: 'NEVERA DE HIELOS' }, { temp: '-23°', nevera: 'HELADERIA 1' },
                { temp: '-21°', nevera: 'HELADERIA 2' }, { temp: '-20°', nevera: 'CONGELADOR HELADERIA 1' },
                { temp: '5°', nevera: 'NEVERA HELADERIA 1' }, { temp: '-20°', nevera: 'CONGELADOR HELADERIA 2' },
                { temp: '5°', nevera: 'NEVERA HELADERIA 2' }, { temp: '5°', nevera: 'NEVERA DE SODAS' },
                { temp: '-22°', nevera: 'HELADOS 1' }, { temp: '-22°', nevera: 'HELADOS 2' },
                { temp: '-24°', nevera: 'H. IMPORTADOS' }, { temp: '-25°', nevera: 'NEVERA PAPAS FRITAS' },
                { temp: '-21°', nevera: 'PANES CONGELADOS' }, { temp: '-25°', nevera: 'MARISCOS CONGELADOS' },
                { temp: '-21°', nevera: 'TORTILLAS CONGELADAS 1' }, { temp: '-25°', nevera: 'TORTILLAS CONGELADAS 2' },
                { temp: '5°', nevera: 'NEVERA PANADERIA' }, { temp: '-20°', nevera: 'CONGELADOR PANADERIA' },
                { temp: '3°', nevera: 'NEVERA CERVEZAS' }, { temp: '3°', nevera: 'NEVERA PRODUCTOS RIMITH' },
                { temp: '4°', nevera: 'NEVERA LACTEOS RIMITH' }, { temp: '4°', nevera: 'NEVERA EMBUTIDOS RIMITH' },
                { temp: '2°', nevera: 'NEVERA QUESOS RIMITH' }, { temp: '4°', nevera: 'NEVERAS CARNES EMPACADAS' },
                { temp: '6°', nevera: 'NEVERA HUEVOS' }, { temp: '4°', nevera: 'NEVERA EMBUTIDOS' },
                { temp: '5°', nevera: 'NEVERA AREPAS' }, { temp: '4°', nevera: 'NEVERA FRUTAS' },
                { temp: '5°', nevera: 'NEVERA FRUTAS ENVASADAS' }, { temp: '3°', nevera: 'TORTILLAS RIMITH' },
                { temp: '2°', nevera: 'NEVERA YOGURT' }, { temp: '4°', nevera: 'NEVERA JUGOS' },
                { temp: '5°', nevera: 'NEVERA MANZANAS' }, { temp: '5°', nevera: 'NEVERA LEGUMBRES' },
                { temp: '4°', nevera: 'NEVERA FLORES' }, { temp: '3°', nevera: 'NEVERAS POLLO (CARNICERIA)' },
                { temp: '3°', nevera: 'NEVERAS CARNES (CARNICERIA)' }, { temp: '3°', nevera: 'NEVERA EMBUTIDOS (CARNICERIA)' },
                { temp: '4°', nevera: 'CUARTO FRIO MEZANINE' }, { temp: '4°', nevera: 'CUARTO FRIO RECIBO' },
                { temp: '-20°', nevera: 'CONGELADOR RECIBO' },
            ];
            const initialRevisionesData = [
                { area: 'PUERTA DE LADO DEL HOTEL' }, { area: 'PUERTA DE SALIDA PRINCIPAL' },
                { area: 'PUERTA DE VIVERO' }, { area: 'PUERTA DE RECIBO' },
                { area: 'PUERTA DE SANIDAD' }, { area: 'PUERTA DEL COMEDOR' },
                { area: 'PUERTA DE DECORACIÓN' }, { area: 'PUERTA DE BACK OFFICE' },
                { area: 'PUERTA OFICINA LIC MELISSA' }, { area: 'PUERTA DE SERVIDORES' },
                { area: 'PUERTA DE SEGURIDAD' }, { area: 'PUERTA DE BÓVEDA' },
            ];

            if (!dataTemperaturas || dataTemperaturas.length === 0 || !dataTemperaturas[0].nevera) {
                dataTemperaturas = initialTemperaturesData.map(item => ({ ...item, t2200: '', t0000: '', t0200: '', t0400: '' }));
            }
            if (!dataRevisiones || dataRevisiones.length === 0 || !dataRevisiones[0].area) {
                dataRevisiones = initialRevisionesData.map(item => ({ ...item, rev1: '', obs1: '', rev2: '', obs2: '', rev3: '', obs3: '' }));
            }

            let seccionActiva = DEFAULT_SECCIONES[0];
            let selectedRow = null;
            let insertIndex = null;
            const chipsEl = document.getElementById('chips');
            const btnExport = document.getElementById('btnExport');
            const btnClear = document.getElementById('btnClear');
            const btnAdd = document.getElementById('btnAdd');
            const btnDeleteRow = document.getElementById('btnDeleteRow');
            const toastContainer = document.getElementById('toast');
            const mainTitle = document.getElementById('main-title');
            const temperaturasTableContainer = document.getElementById('temperaturas-table-container');
            const revisionesTableContainer = document.getElementById('revisiones-table-container');
            const fileInput = document.getElementById('fileInput');
            const btnExportJson_menu = document.getElementById('btnExportJson_menu');
            const btnImportJson_menu = document.getElementById('btnImportJson_menu');
            const sideMenu = document.getElementById('sideMenu');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const overlay = document.getElementById('overlay');
            const deleteModal = document.getElementById('deleteModal');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const clearModal = document.getElementById('clearModal');
            const clearModalConfirmBtn = document.getElementById('clearModalConfirmBtn');
            const clearModalCancelBtn = document.getElementById('clearModalCancelBtn');
            const allCloseBtns = document.querySelectorAll('.close-btn');

            let saveTimer = null;
            function save() {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    localStorage.setItem(STORAGE_KEY_TEMPERATURAS, JSON.stringify(dataTemperaturas));
                    localStorage.setItem(STORAGE_KEY_REVISIONES, JSON.stringify(dataRevisiones));
                }, 300);
            }

            function showToast(msg, type = 'success') {
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.textContent = msg;
                toastContainer.appendChild(t);
                setTimeout(() => {
                    t.style.opacity = '0';
                    t.style.transform = 'translateY(20px)';
                    setTimeout(() => t.remove(), 500);
                }, 2000);
            }

            function renderChips() {
                chipsEl.innerHTML = '';
                DEFAULT_SECCIONES.forEach(s => {
                    const b = document.createElement('div');
                    b.className = 'chip' + (s === seccionActiva ? ' active' : '');
                    b.textContent = s;
                    b.onclick = () => {
                        seccionActiva = s;
                        render();
                    };
                    chipsEl.appendChild(b);
                });
            }

            const applyColorAndAlertLogic = (targetInput, suppressToast = true) => {
                const currentRowInputs = Array.from(targetInput.closest('tr').querySelectorAll('input[type="number"]'));
                const currentIndex = currentRowInputs.indexOf(targetInput);
                const currentValue = parseFloat(targetInput.value);
                const prevInput = currentRowInputs[currentIndex - 1];
                const prevValue = prevInput ? parseFloat(prevInput.value) : NaN;
                targetInput.classList.remove('initial-highlight', 'increased', 'decreased');
                if (currentIndex > 0 && !isNaN(currentValue) && !isNaN(prevValue)) {
                    if (currentValue < prevValue) {
                        targetInput.classList.add('decreased');
                        if (!suppressToast) showToast('¡Advertencia! Diferencia detectada.', 'warning');
                    } else if (currentValue > prevValue) {
                        targetInput.classList.add('increased');
                    }
                }
            };
            
            function render() {
                renderChips();
                selectedRow = null;
                let dataToRender;
                let tbody;
                let tableContainer;
                let title;

                if (seccionActiva === 'TEMPERATURAS') {
                    dataToRender = dataTemperaturas;
                    tbody = document.getElementById('temperaturas-tbody');
                    tableContainer = temperaturasTableContainer;
                    title = 'REVISIÓN DE TEMPERATURAS';
                    revisionesTableContainer.style.display = 'none';
                } else {
                    dataToRender = dataRevisiones;
                    tbody = document.getElementById('revisiones-tbody');
                    tableContainer = revisionesTableContainer;
                    title = 'REVISIÓN DE INSTALACIONES';
                    temperaturasTableContainer.style.display = 'none';
                }
                
                mainTitle.textContent = title;
                tableContainer.style.display = 'block';
                tbody.innerHTML = '';

                if (!dataToRender.length) {
                    tbody.innerHTML = '<tr><td colspan="7" style="color:#666;text-align:center;padding:20px;">Sin datos en esta sección.</td></tr>';
                    return;
                }

                dataToRender.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    if (seccionActiva === 'TEMPERATURAS') {
                        tr.innerHTML = `
                            <td contenteditable="true" data-field="temp">${item.temp || ''}</td>
                            <td class="left" contenteditable="true" data-field="nevera">${item.nevera || ''}</td>
                            <td><input type="number" data-field="t2200" value="${item.t2200 || ''}"></td>
                            <td><input type="number" data-field="t0000" value="${item.t0000 || ''}"></td>
                            <td><input type="number" data-field="t0200" value="${item.t0200 || ''}"></td>
                            <td><input type="number" data-field="t0400" value="${item.t0400 || ''}"></td>
                        `;
                    } else {
                        tr.innerHTML = `
                            <td contenteditable="true" data-field="area">${item.area || ''}</td>
                            <td><input type="text" data-field="rev1" value="${item.rev1 || ''}"></td>
                            <td><input type="text" data-field="obs1" value="${item.obs1 || ''}"></td>
                            <td><input type="text" data-field="rev2" value="${item.rev2 || ''}"></td>
                            <td><input type="text" data-field="obs2" value="${item.obs2 || ''}"></td>
                            <td><input type="text" data-field="rev3" value="${item.rev3 || ''}"></td>
                            <td><input type="text" data-field="obs3" value="${item.obs3 || ''}"></td>
                        `;
                    }

                    tr.querySelectorAll('[contenteditable="true"]').forEach(td => {
                        td.addEventListener('blur', () => {
                            const field = td.dataset.field;
                            dataToRender[index][field] = td.innerText.trim();
                            save();
                        });
                    });

                    tr.querySelectorAll('input').forEach((inp, idx) => {
                        if (seccionActiva === 'TEMPERATURAS' && inp.type === 'number') {
                            applyColorAndAlertLogic(inp, true);
                            inp.addEventListener('input', () => {
                                const field = inp.dataset.field;
                                dataToRender[index][field] = inp.value.trim();
                                save();
                                applyColorAndAlertLogic(inp, false);
                                const currentRowInputs = Array.from(inp.closest('tr').querySelectorAll('input[type="number"]'));
                                const currentIndex = currentRowInputs.indexOf(inp);
                                for (let j = currentIndex + 1; j < currentRowInputs.length; j++) {
                                    applyColorAndAlertLogic(currentRowInputs[j], true);
                                }
                            });
                        } else {
                            inp.addEventListener('input', () => {
                                const field = inp.dataset.field;
                                dataToRender[index][field] = inp.value.trim();
                                save();
                            });
                        }
                    });
                    
                    tr.addEventListener('click', () => {
                        if (selectedRow) selectedRow.classList.remove('selected-row');
                        selectedRow = tr;
                        selectedRow.classList.add('selected-row');
                        insertIndex = index;
                    });
                    
                    tbody.appendChild(tr);
                });
            }

            btnAdd.onclick = () => {
                let newData;
                if (seccionActiva === 'TEMPERATURAS') {
                    newData = { temp: '', nevera: '', t2200: '', t0000: '', t0200: '', t0400: '' };
                    dataTemperaturas.push(newData);
                } else {
                    newData = { area: '', rev1: '', obs1: '', rev2: '', obs2: '', rev3: '', obs3: '' };
                    dataRevisiones.push(newData);
                }
                save();
                render();
                showToast('Fila agregada.', 'success');
            };

            btnDeleteRow.onclick = () => {
                if (insertIndex !== null) {
                    deleteModal.style.display = 'block';
                } else {
                    showToast('Selecciona una fila.', 'error');
                }
            };

            btnClear.onclick = () => {
                clearModal.style.display = 'block';
            };

            modalConfirmBtn.onclick = () => {
                if (insertIndex !== null) {
                    if (seccionActiva === 'TEMPERATURAS') {
                        dataTemperaturas.splice(insertIndex, 1);
                    } else {
                        dataRevisiones.splice(insertIndex, 1);
                    }
                    save();
                    render();
                    showToast('Fila eliminada.', 'success');
                    deleteModal.style.display = 'none';
                    insertIndex = null;
                }
            };
            modalCancelBtn.onclick = () => { deleteModal.style.display = 'none'; };
            clearModalConfirmBtn.onclick = () => {
                if (seccionActiva === 'TEMPERATURAS') {
                    dataTemperaturas = dataTemperaturas.map(item => ({ ...item, t2200: '', t0000: '', t0200: '', t0400: '' }));
                } else {
                    dataRevisiones = dataRevisiones.map(item => ({ ...item, rev1: '', obs1: '', rev2: '', obs2: '', rev3: '', obs3: '' }));
                }
                save();
                render();
                showToast('Horarios borrados.', 'success');
                clearModal.style.display = 'none';
            };
            clearModalCancelBtn.onclick = () => { clearModal.style.display = 'none'; };
            allCloseBtns.forEach(btn => {
                btn.onclick = () => { btn.closest('.modal').style.display = 'none'; };
            });
            window.onclick = (event) => {
                if (event.target === deleteModal) deleteModal.style.display = 'none';
                if (event.target === clearModal) clearModal.style.display = 'none';
            };

            function getPdfCellClass(currentValue, prevValue) {
                const numCurrent = parseFloat(currentValue);
                const numPrev = parseFloat(prevValue);
                if (!isNaN(numCurrent) && !isNaN(numPrev)) {
                    if (numCurrent < numPrev) return 'decreased';
                    if (numCurrent > numPrev) return 'increased';
                }
                return '';
            }
            
            btnExport.onclick = () => {
                if (!dataTemperaturas.length && !dataRevisiones.length) {
                    showToast('No hay datos para exportar', 'warning');
                    return;
                }
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                const formattedToday = `${day}/${month}/${year}`;
                
                const reviewDateInput = document.getElementById('review-date').value;
                const formattedReviewDate = reviewDateInput ? 
                    new Date(reviewDateInput).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : formattedToday;

                const vespertinoNombre = document.getElementById('vespertino-nombre').value.trim();
                const nocturnoNombre = document.getElementById('nocturno-nombre').value.trim();

                let html = `
                <html>
                <head>
                    <title>Reporte Riba Smith</title>
                    <style>
                        body { font-family: 'Poppins', sans-serif; margin: 30px; color: #111; }
                        h1, h2, h3 { margin: 5px 0; text-align: center; }
                        .pdf-header { text-align: center; margin-bottom: 20px; }
                        .pdf-header h1 { font-size: 20pt; font-weight: 700; text-transform: uppercase; }
                        .pdf-header p { font-size: 16pt; font-weight: bold; margin-top: 5px; }
                        .pdf-header-details {
                            display: flex;
                            flex-wrap: wrap;
                            justify-content: space-between;
                            width: 90%;
                            margin: 0 auto 20px auto;
                            font-size: 12pt;
                            font-weight: bold;
                        }
                        .pdf-header-details div {
                            margin-bottom: 10px;
                        }
                        .pdf-section-title { margin-top: 25px; font-size: 16pt; font-weight: 700; text-align: center; text-transform: uppercase; }
                        table { width: 90%; border-collapse: collapse; margin: 15px auto; font-size: 12pt; table-layout: fixed; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                        th { background: #f0f0f0; font-weight: bold; }
                        .increased { background-color: #d4edda !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .decreased { background-color: #f8d7da !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .page-break { page-break-before: always; }
                        .pdf-footer { text-align: center; font-size: 16pt; font-weight: bold; color: #666; margin-top: 20px; position: relative; }
                    </style>
                </head>
                <body>
                    <div class="pdf-header">
                        <h1>GRUPO RIBA SMITH</h1>
                        <h2>R/S CHITRÉ SELECTO</h2>
                        <h1>REVISIÓN DE INSTALACIONES Y TEMPERATURAS</h1>
                    </div>
                    <div class="pdf-header-details">
                        <div>Fecha de Revisión: ${formattedReviewDate}</div>
                        <div>Revisión Vespertina: ${vespertinoNombre || "________________"}</div>
                        <div>Revisión Nocturna: ${nocturnoNombre || "________________"}</div>
                    </div>
                `;
                if (dataTemperaturas.length) {
                    html += `
                    <div class="pdf-section-title">Temperaturas</div>
                    <table>
                        <thead>
                            <tr>
                                <th>TEMP</th>
                                <th>NEVERAS</th>
                                <th>22:00</th>
                                <th>00:00</th>
                                <th>02:00</th>
                                <th>04:00</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    dataTemperaturas.forEach(d => {
                        const class22 = getPdfCellClass(d.t2200, d.temp);
                        const class00 = getPdfCellClass(d.t0000, d.t2200);
                        const class02 = getPdfCellClass(d.t0200, d.t0000);
                        const class04 = getPdfCellClass(d.t0400, d.t0200);
                        html += `
                            <tr>
                                <td>${d.temp || ""}</td>
                                <td style="text-align: left;">${d.nevera || ""}</td>
                                <td class="${class22}">${d.t2200 || ""}</td>
                                <td class="${class00}">${d.t0000 || ""}</td>
                                <td class="${class02}">${d.t0200 || ""}</td>
                                <td class="${class04}">${d.t0400 || ""}</td>
                            </tr>`;
                    });
                    html += `</tbody></table>`;
                }
                if (dataRevisiones.length) {
                    if (dataTemperaturas.length) {
                        html += `<div class="page-break"></div>`;
                    }
                    html += `
                    <div class="pdf-section-title">Revisiones</div>
                    <table>
                        <thead>
                            <tr>
                                <th>PUERTAS Y/O ÁREAS</th>
                                <th>REVISIÓN Nº1</th>
                                <th>OBSERVACIÓN</th>
                                <th>REVISIÓN Nº2</th>
                                <th>OBSERVACIÓN</th>
                                <th>REVISIÓN Nº3</th>
                                <th>OBSERVACIÓN</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    dataRevisiones.forEach(d => {
                        html += `
                            <tr>
                                <td style="text-align: left;">${d.area || ""}</td>
                                <td>${d.rev1 || ""}</td>
                                <td>${d.obs1 || ""}</td>
                                <td>${d.rev2 || ""}</td>
                                <td>${d.obs2 || ""}</td>
                                <td>${d.rev3 || ""}</td>
                                <td>${d.obs3 || ""}</td>
                            </tr>`;
                    });
                    html += `</tbody></table>`;
                }
                html += `<div class="pdf-footer">Powered by Rafael Ramos</div></body></html>`;
                const win = window.open("", "_blank");
                win.document.write(html);
                win.document.close();
                win.focus();
                setTimeout(() => win.print(), 500);
            };

            const handleExportJson = () => {
                const data = { temperaturas: dataTemperaturas, revisiones: dataRevisiones };
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_chitre_selecto_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Datos exportados.', 'success');
            };
            const handleImportJson = () => { fileInput.click(); };
            btnExportJson_menu.onclick = handleExportJson;
            btnImportJson_menu.onclick = handleImportJson;
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.temperaturas && Array.isArray(importedData.temperaturas) &&
                            importedData.revisiones && Array.isArray(importedData.revisiones)) {
                            dataTemperaturas = importedData.temperaturas;
                            dataRevisiones = importedData.revisiones;
                            save();
                            render();
                            showToast('Datos importados con éxito.', 'success');
                        } else {
                            showToast('Archivo JSON no válido.', 'error');
                        }
                    } catch (error) {
                        showToast('Error al procesar el archivo.', 'error');
                    } finally { event.target.value = ''; }
                };
                reader.readAsText(file);
            };

            hamburgerBtn.addEventListener('click', () => {
                sideMenu.classList.toggle('open');
                overlay.classList.toggle('active');
            });
            overlay.addEventListener('click', () => {
                sideMenu.classList.remove('open');
                overlay.classList.remove('active');
            });

            window.addEventListener("load", () => {
                setTimeout(() => { document.getElementById("splash").style.opacity = "0"; }, 1500);
                setTimeout(() => { document.getElementById("splash").style.display = "none"; }, 2000);
                render();
            });
        })();
    </script>
</body>
</html>
